---
title: "script_supp_figures"
author: "Timothée Bigot"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    code_folding: hide
  pdf_document: 
    toc: true
    toc_depth: 3
    highlight: zenburn
editor_options: 
  chunk_output_type: console
---
---
title:  "supp_figures à jour le 08/04/2022"
---

This Rmarkdown contains the code to obtain all plots necessary to produce our bioinformatical related supplemental figures. Final figure anotation and layout were produced with PhotoShop.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
OUTPUT_PATH <- "$WORKING_DIR/03_2020-42-set1et2/combined/"

ctrl.object <- readRDS(file = "$WORKING_DIR/03_2020-42-set1et2/ctrl_object.rds")
pat.object <- readRDS(file = "$WORKING_DIR/03_2020-42-set1et2/pat_object.rds")
ETV6_2020 <- readRDS(file = "$WORKING_DIR/03_2020-42-set1et2/ETV6_2020_regressed_final.rds")

all.genes <- rownames(ETV6_2020)

library(Seurat)
library(ggplot2)
library(dplyr)
library(ggrepel)
library(DT)
```

# supp_Figure 1 {.tabset}
## Panel A
```{r,fig.width=10,fig.height=10}
# Plotting ctrl.object UMAP with "individuals"
DimPlot(object = ctrl.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "individuals",
        cols = c("#0057B8","#FFD700"),
        order = T
        )
```

## Panel B
```{r,fig.width=10,fig.height=10}
# Plotting ctrl.object UMAP with "orig.ident" split by "individuals"
ctrl.object@meta.data$orig.ident <- factor(ctrl.object@meta.data$orig.ident,
                                           levels = c("D6", "D11")
                                           )
DimPlot(object = ctrl.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "orig.ident",
        split.by = "individuals",
        order = T
        )
```

## Panel C
```{r,fig.width=10,fig.height=10}
# Plotting ctrl.object UMAP with "RNA_snn_res.1.2" and split by "individuals"
DimPlot(object = ctrl.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "RNA_snn_res.1.2",
        split.by = "individuals",
        order = T,
        label = T,
        label.size = 5
        )

```

## Panel D

* See "script_figures.Rmd"

# supp_Figure 2
```{r}
# FindAllMarkers
if(file.exists(paste(OUTPUT_PATH, "ctrl_FAM.csv", sep = ""))){
  ctrl.markers <- read.csv(file = paste(OUTPUT_PATH, "ctrl_FAM.csv", sep = ""))
  }else{
  Idents(ctrl.object) <- "RNA_snn_res.1.2"
  ctrl.markers <- FindAllMarkers(ctrl.object,
                                        only.pos = F,
                                        min.pct = 0.1,
                                        logfc.threshold = 0.25,
                                        verbose = T
                                        )
  write.csv(ctrl.markers,
                   file = paste(OUTPUT_PATH,
                                "ctrl_FAM.csv",
                                sep = ""
                   )
            )
  }

top_genes <- ctrl.markers %>% group_by(cluster) %>% top_n(20, avg_log2FC)
```

```{r,fig.width=10,fig.height=20}
### Heatmap
str_top_genes <- unique(as.character(top_genes$gene))
DoHeatmap(object = ctrl.object, features = as.character(top_genes$gene),group.by = "RNA_snn_res.1.2", group.bar = T, label = T,size = 5, draw.lines = T, lines.width = 10,group.bar.height = 0.02)
```

# supp_Figure 3 {.tabset}
## Panel A

* See "script_figures.Rmd" 

# supp_figure 4
```{r}
ctrl.object <- readRDS(file = "$WORKING_DIR/03_2020-42-set1et2/ctrl_object.rds")

OUTPUT_PATH <- "$WORKING_DIR/FAM/"

ctrl.object@meta.data$celltypes <- factor(ctrl.object@meta.data$celltypes, levels = c("HSPC","GMP","CMP","CMP_Primed","MEP","MkP_Mk","Plt"))

# FindAllMarkers
if(file.exists(paste0(OUTPUT_PATH, "ctrl.object_FAM_regulons.csv"))){
  ctrl.regulons <- read.csv(file = paste0(OUTPUT_PATH, "ctrl.object_FAM_regulons.csv"))
  }else{
  Idents(ctrl.object) <- "celltypes"
  ctrl.regulons <- FindAllMarkers(ctrl.object,
                                  only.pos = F,
                                  min.pct = 0.1,
                                  logfc.threshold = 0,
                                  verbose = T,
                                  assay = "AUC",
                                  test.use = "wilcox"
                                  )
  write.csv(ctrl.regulons,
                   file = paste0(OUTPUT_PATH,
                                "ctrl.object_FAM_regulons.csv"
                                )
            )
  }

all.regulons <- rownames(ctrl.object@assays$AUC)

ctrl.object <- ScaleData(ctrl.object, assay = "AUC", features = all.regulons, do.scale = T, do.center = T)

ctrl.top20 <- ctrl.regulons %>% group_by(cluster) %>% top_n(20, avg_log2FC)

# datatable(ctrl.regulons, filter = 'top', options = list(pageLength = 20)) %>% formatRound(2:4, 2) %>% formatSignif(c(1,5), digits = 2)

## Heatmap top 20 regulons FAM in controls 

DoHeatmap(ctrl.object, features = ctrl.top20$gene, group.by = "celltypes", assay = "AUC", slot = "scale.data", label = T, raster = T) + scale_fill_gradientn(colors = c("blue","white","red"))
```


# supp_figure 6

## Panel A
```{r}
# Plotting pat.object UMAP with "individuals"
DimPlot(object = pat.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "individuals",
        cols = c("#0057B8","#FFD700"),
        order = T
        )
```

## Panel B
```{r,fig.width=10,fig.height=10}
# Plotting pat.object UMAP with "orig.ident" split by "individuals"
pat.object@meta.data$orig.ident <- factor(pat.object@meta.data$orig.ident,
                                           levels = c("D6", "D11")
                                           )
DimPlot(object = pat.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "orig.ident",
        order = T,
        split.by = "individuals"
        )
```

## Panel C
```{r,fig.width=10,fig.height=10}
# Plotting pat.object UMAP with "RNA_snn_res.0.8" split by "individuals"
ggplotly(DimPlot(object = pat.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "RNA_snn_res.0.8",
        order = T,
        label = T,
        label.size = 6,
        split.by = "individuals"
        ))
```

```{r}
# FindAllMarkers
if(file.exists(paste(OUTPUT_PATH, "pat_FAM.csv", sep = ""))){
  pat.markers <- read.csv(file = paste(OUTPUT_PATH, "pat_FAM.csv", sep = ""))
  }else{
  Idents(pat.object) <- "RNA_snn_res.0.8"
  pat.markers <- FindAllMarkers(pat.object,
                                        only.pos = F,
                                        min.pct = 0.1,
                                        logfc.threshold = 0.25,
                                        verbose = T
                                        )
  write.csv(pat.markers,
                   file = paste(OUTPUT_PATH,
                                "pat_FAM.csv",
                                sep = ""
                   )
            )
  }

top_genes <- pat.markers %>% group_by(cluster) %>% top_n(20, avg_log2FC)
```


## Panel D

* See "script_figures.Rmd"

# supp_figure 7

* See "script_figures.Rmd"

# supp_figure 8
```{r,fig.width=10,fig.height=20}
### Heatmap
str_top_genes <- unique(as.character(top_genes$gene))
DoHeatmap(object = pat.object, features = as.character(top_genes$gene),group.by = "RNA_snn_res.0.8", group.bar = T, label = T,size = 5, draw.lines = T, lines.width = 10,group.bar.height = 0.02)
```

#supp_figure 9 
```{r}
OUTPUT_PATH <- "<WORKING_DIR>/FAM/"

auc_ETV6_2020@meta.data$celltypes <- factor(auc_ETV6_2020@meta.data$celltypes, levels = c("HSPC","GMP","CMP","CMP_Primed","MEP","MkP_Mk","Plt"))

# FindAllMarkers
if(file.exists(paste0(OUTPUT_PATH, "auc_ETV6_2020_FAM_regulons.csv"))){
  regulons <- read.csv(file = paste0(OUTPUT_PATH, "auc_ETV6_2020_FAM_regulons.csv"))
  }else{
  Idents(auc_ETV6_2020) <- "celltypes"
  regulons <- FindAllMarkers(auc_ETV6_2020,
                                  only.pos = F,
                                  min.pct = 0.1,
                                  logfc.threshold = 0,
                                  verbose = T,
                                  assay = "AUC"
                                  )
  write.csv(regulons,
                   file = paste0(OUTPUT_PATH,
                                "auc_ETV6_2020_FAM_regulons.csv"
                                )
            )
  }


## Heatmap all regulons in every cells

all.regulons <- rownames(auc_ETV6_2020@assays$AUC)

auc_ETV6_2020@meta.data$celltypes_ETV6status <- factor(auc_ETV6_2020@meta.data$celltypes_ETV6status, levels = c("Controls_HSPC","Patients_HSPC","Controls_GMP","Patients_GMP","Controls_CMP_Primed","Patients_CMP_Primed","Controls_CMP","Patients_CMP","Controls_MEP","Patients_MEP","Controls_MkP_Mk","Patients_MkP_Mk","Controls_Plt","Patients_Plt"))

auc_ETV6_2020 <- ScaleData(auc_ETV6_2020,
                           assay = "AUC",
                           features = all.regulons,
                           do.scale = T,
                           do.center = T,
                           model.use = "linear",
                           verbose = T
                           )

DoHeatmap(auc_ETV6_2020, features = all.regulons, group.by = "celltypes_ETV6status", assay = "AUC", slot = "scale.data", label = T) + scale_fill_gradientn(colors = c("blue","white","red"))
```

# supp_figure 10  
```{r}
# Comparing AUC activities for patients versus controls in every celltypes
Idents(auc_ETV6_2020) <- "celltypes_ETV6status"

list_tmp <- c(unique(auc_ETV6_2020@meta.data$celltypes))

OUTPUT_PATH <- "$WORKING_DIR/FM/"

for (i in list_tmp[1:length(list_tmp)]){
  if(i != "Plt"){
    if(file.exists(paste0(OUTPUT_PATH,paste0("celltype_", i,".reg_ETV6_2020_full.csv")))){
       assign(paste0("celltype_", i,".reg"),read.csv(paste0(OUTPUT_PATH,paste0("celltype_", i,".reg_ETV6_2020_full.csv"))))}
    else{
      assign(paste0("celltype_", i,".reg"), FindMarkers(auc_ETV6_2020,assay = "AUC", ident.1 = paste("Patients", i, sep = "_"), ident.2 = paste("Controls", i, sep = "_"), only.pos = F, test.use = "wilcox", logfc.threshold = 0, min.pct = 0))
      print(paste0("celltype_", i,".reg"))
      print(head(get(paste0("celltype_", i,".reg")),n=50))
      write.table(get(paste0("celltype_", i,".reg")),
                  paste0(OUTPUT_PATH, "celltype_", i,".reg_ETV6_2020_full.csv"), sep = ",", quote = F)}
  }
}
```

# Heatmaps auc_ETV6_2020 analysis

```{r}
OUTPUT_PATH <- "$WORKING_DIR/FM/"

# Selecting Top 20 genes per cluster and making a list of it
for (i in list_tmp[1:length(list_tmp)]) {
   if(i != "Plt"){
     assign(paste0("celltype_", i,".top20"),rownames(get(paste0("celltype_", i,".reg")) %>% top_n(20, avg_log2FC)))
     write.table(get(paste0("celltype_", i,".reg")),
                  paste0(OUTPUT_PATH, "celltype_", i,".reg_ETV6_2020_top20.csv"), sep = ",", quote = F)
     }
}


## Heatmaps
DoHeatmap(auc_ETV6_2020, features = celltype_MkP_Mk.top20, group.by = "celltypes_ETV6status", assay = "AUC", slot = "scale.data", cells = rownames(auc_ETV6_2020@meta.data[auc_ETV6_2020@meta.data$celltypes == "MkP_Mk",])) + scale_fill_gradientn(colors = c("blue","white","red"))

DoHeatmap(auc_ETV6_2020, features = celltype_CMP.top20, group.by = "celltypes_ETV6status", assay = "AUC", slot = "scale.data", cells = rownames(auc_ETV6_2020@meta.data[auc_ETV6_2020@meta.data$celltypes == "CMP",])) + scale_fill_gradientn(colors = c("blue","white","red"))

DoHeatmap(auc_ETV6_2020, features = celltype_MEP.top20, group.by = "celltypes_ETV6status", assay = "AUC", slot = "scale.data", cells = rownames(auc_ETV6_2020@meta.data[auc_ETV6_2020@meta.data$celltypes == "MEP",])) + scale_fill_gradientn(colors = c("blue","white","red"))
```

# supp_figures 11 & 12 

* See "script_figures.Rmd"

# supp_Figure 5 {.tabset}
## Panel A
```{r,fig.width=10,fig.height=10}
# FeaturePlots {.tabset}
sig_list <- c("DNM1L","CYCS")

for (i in 1:length(sig_list)){
    tryCatch({
      print(sig_list[i])
      print(FeaturePlot(object = ETV6_2020,
                        features = sig_list[i],
                        reduction = "umap",
                        cols = c("grey","lightblue","cyan3","cyan4","dodgerblue3","blue","mediumslateblue","purple","orchid3","red","brown","black"),
                        pt.size = 0.7)+
              NoAxes()+
              NoLegend()
            )
    }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
}
```

## Panel B 

* See "script_figures.Rmd"