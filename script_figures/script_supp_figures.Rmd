---
title: "script_supp_figures"
author: "Timothée Bigot"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    code_folding: hide
  pdf_document: 
    toc: true
    toc_depth: 3
    highlight: zenburn
editor_options: 
  chunk_output_type: console
---
---
title:  "supp_figures à jour le 08/04/2022"
---

This Rmarkdown contains the code to obtain all plots necessary to produce our bioinformatical related supplemental figures. Final figure anotation and layout were produced with PhotoShop.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
OUTPUT_PATH <- "$WORKING_DIR/03_2020-42-set1et2/combined/"

ctrl.object <- readRDS(file = "$WORKING_DIR/03_2020-42-set1et2/ctrl_object.rds")
pat.object <- readRDS(file = "$WORKING_DIR/03_2020-42-set1et2/pat_object.rds")
ETV6_2020 <- readRDS(file = "$WORKING_DIR/03_2020-42-set1et2/ETV6_2020_regressed_final.rds")

all.genes <- rownames(ETV6_2020)

library(Seurat)
library(ggplot2)
library(dplyr)
library(ggrepel)
library(DT)
```

# supp_Figure 1 {.tabset}
## Panel A
```{r,fig.width=10,fig.height=10}
# Plotting ctrl.object UMAP with "individuals"
DimPlot(object = ctrl.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "individuals",
        cols = c("#0057B8","#FFD700"),
        order = T
        )
```

## Panel B
```{r,fig.width=10,fig.height=10}
# Plotting ctrl.object UMAP with "orig.ident" split by "individuals"
ctrl.object@meta.data$orig.ident <- factor(ctrl.object@meta.data$orig.ident,
                                           levels = c("D6", "D11")
                                           )
DimPlot(object = ctrl.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "orig.ident",
        split.by = "individuals",
        order = T
        )
```

## Panel C
```{r,fig.width=10,fig.height=10}
# Plotting ctrl.object UMAP with "RNA_snn_res.1.2" and split by "individuals"
DimPlot(object = ctrl.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "RNA_snn_res.1.2",
        split.by = "individuals",
        order = T,
        label = T,
        label.size = 5
        )

```

## Panel D
```{r,fig.width=10,fig.height=10}
myColors <- c("#53B400","#F8766D","#C49A00","#00C094","#00B6EB","#00B6EB","#00B6EB","#00B6EB","#00B6EB","#A58AFF","#A58AFF","#A58AFF","#A58AFF","#A58AFF","#FB61D7")

gene <- c("nFeature_RNA","nCount_RNA","GP6","P2RY1","MYH9")

for (i in gene) {
  Idents(ctrl.object) <- "RNA_snn_res.1.2"
  ctrl.object@meta.data$RNA_snn_res.1.2 <- factor(ctrl.object@meta.data$RNA_snn_res.1.2,
                                                  levels = c("13","7","11","10","9","5","4","0","2","1","3","6","8","12","14")
                                                  )
  p1 <- VlnPlot(ctrl.object,
                features = i,
                pt.size = 0,
                group.by = "RNA_snn_res.1.2",
                log = F,
                cols = myColors,
                assay = "RNA"
                ) + NoLegend() + geom_boxplot()
```

# supp_Figure 2
```{r}
# FindAllMarkers
if(file.exists(paste(OUTPUT_PATH, "ctrl_FAM.csv", sep = ""))){
  ctrl.markers <- read.csv(file = paste(OUTPUT_PATH, "ctrl_FAM.csv", sep = ""))
  }else{
  Idents(ctrl.object) <- "RNA_snn_res.1.2"
  ctrl.markers <- FindAllMarkers(ctrl.object,
                                        only.pos = F,
                                        min.pct = 0.1,
                                        logfc.threshold = 0.25,
                                        verbose = T
                                        )
  write.csv(ctrl.markers,
                   file = paste(OUTPUT_PATH,
                                "ctrl_FAM.csv",
                                sep = ""
                   )
            )
  }

top_genes <- ctrl.markers %>% group_by(cluster) %>% top_n(20, avg_log2FC)

### Heatmap
str_top_genes <- unique(as.character(top_genes$gene))
DoHeatmap(object = ctrl.object, features = as.character(top_genes$gene),group.by = "RNA_snn_res.1.2", group.bar = T, label = T,size = 5, draw.lines = T, lines.width = 10,group.bar.height = 0.02)
```

# supp_figure 4
```{r}
# FindAllMarkers
if(file.exists(paste(OUTPUT_PATH, "pat_FAM.csv", sep = ""))){
  pat.markers <- read.csv(file = paste(OUTPUT_PATH, "pat_FAM.csv", sep = ""))
  }else{
  Idents(pat.object) <- "RNA_snn_res.0.8"
  pat.markers <- FindAllMarkers(pat.object,
                                        only.pos = F,
                                        min.pct = 0.1,
                                        logfc.threshold = 0.25,
                                        verbose = T
                                        )
  write.csv(pat.markers,
                   file = paste(OUTPUT_PATH,
                                "pat_FAM.csv",
                                sep = ""
                   )
            )
  }

top_genes <- pat.markers %>% group_by(cluster) %>% top_n(20, avg_log2FC)

### Heatmap
str_top_genes <- unique(as.character(top_genes$gene))
DoHeatmap(object = pat.object, features = as.character(top_genes$gene),group.by = "RNA_snn_res.0.8", group.bar = T, label = T,size = 5, draw.lines = T, lines.width = 10,group.bar.height = 0.02)
```

# supp_figure 6

## Panel A

* EnrichR

## Panel B

* EnrichR

# supp_figure 7

## Panel A

* EnrichR

## Panel B

* EnrichR

# supp_figure 8
```{r,fig.width=10,fig.height=20}
# translation pathways
ribosomal_genes <- c("RPS6","RPL4","RPL5","RPL30","MRPS15","RPL3","RPL32","RPL31","RPL34","RPLP1","RPLP0","RPL8","RPL10A","RPL9","RPL6","RPL7","RPS15","EEF1B2","RPS4X","RPS14","RPL7A","MTRF1","RPS16","EEF2K","RPS19","RPL18A","RPS18","RPL36","RPLP2","RPL38","RPL37","RPS11","RPL39","RPS10","RPS13","RPS9","RPL21","RPS7","RPS8","RPS5","RPL22","DRPS","RPL13A","RPSA","RPS3A","EEF1A1","EEF1G","EEF1D","NOA1","RPL37A","RPL24","RPL27","RPL26","RPL29","RPL28","MRRF","RPL12","RPL11","MRPL16","RPL36A","RPS4Y1","GSPT2","MRPL10","RPS15A","RPL14","RPS3","RPL13","RPL15","RPL18","RPS27A","RPL17","EIF4B","RPL19","RPL41","MTERF4","GATC","RPL35A","RPL23A","EEF2","HARS2","RPS25","RPS28","RPS27","QARS","TNIP1","RPS29","RPL27A","RPS20","RPS21","RSL24D1","RPS24","RPS23")

DoHeatmap(ETV6_2020, features = ribosomal_genes, group.by = "ETV6status", assay = "RNA", slot = "scale.data", label = T, raster = F, cells = rownames(ETV6_2020@meta.data[ETV6_2020@meta.data$celltypes == "MkP_Mk",]), ) + scale_fill_gradientn(colors = c("blue","white","red"))
```
