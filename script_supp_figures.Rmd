---
title: "script_supp_figures"
author: "Timothée Bigot"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    code_folding: hide
  pdf_document: 
    toc: true
    toc_depth: 3
    highlight: zenburn
editor_options: 
  chunk_output_type: console
---
---
title:  "supp_figures à jour le 08/04/2022"
---

This Rmarkdown contains the code to obtain all plots necessary to produce our bioinformatical related supplemental figures. Final figure anotation and layout were produced with PhotoShop.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
OUTPUT_PATH <- "/home/bigott/workspace2/01_tim/01_these/01_etv6/05_Outputs/06_Février_2022/03_2020-42-set1et2/combined/"

ctrl.object <- readRDS(file = "/home/bigott/workspace2/01_tim/01_these/01_etv6/05_Outputs/06_Février_2022/03_2020-42-set1et2/ctrl/ctrl_object.rds")
pat.object <- readRDS(file = "/home/bigott/workspace2/01_tim/01_these/01_etv6/05_Outputs/06_Février_2022/03_2020-42-set1et2/patients/pat_object.rds")
ETV6_2020 <- readRDS(file = "/home/bigott/workspace2/01_tim/01_these/01_etv6/05_Outputs/06_Février_2022/03_2020-42-set1et2/combined/ETV6_2020_regressed_final.rds")

all.genes <- rownames(ETV6_2020)

library(Seurat)
library(ggplot2)
library(dplyr)
library(ggrepel)
library(DT)
```

# supp_Figure 1 {.tabset}
## Panel 0
```{r,fig.width=10,fig.height=10}
# Plotting ctrl.object UMAP with "individuals"
DimPlot(object = ctrl.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "individuals",
        order = T
        )
```

## Panel A
```{r,fig.width=10,fig.height=10}
# Plotting ctrl.object UMAP with "orig.ident" split by "individuals"
ctrl.object@meta.data$orig.ident <- factor(ctrl.object@meta.data$orig.ident,
                                           levels = c("D6", "D11")
                                           )
DimPlot(object = ctrl.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "orig.ident",
        split.by = "individuals",
        order = T
        )
```

## Panel B
```{r,fig.width=10,fig.height=10}
# Plotting ctrl.object UMAP with "RNA_snn_res.1.2" and split by "individuals"
DimPlot(object = ctrl.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "RNA_snn_res.1.2",
        split.by = "individuals",
        order = T,
        label = T,
        label.size = 5
        )
```

# supp_Figure 2
```{r}
# FindAllMarkers
if(file.exists(paste(OUTPUT_PATH, "ctrl_FAM.csv", sep = ""))){
  ctrl.markers <- read.csv(file = paste(OUTPUT_PATH, "ctrl_FAM.csv", sep = ""))
  }else{
  Idents(ctrl.object) <- "RNA_snn_res.1.2"
  ctrl.markers <- FindAllMarkers(ctrl.object,
                                        only.pos = F,
                                        min.pct = 0.1,
                                        logfc.threshold = 0.25,
                                        verbose = T
                                        )
  write.csv(ctrl.markers,
                   file = paste(OUTPUT_PATH,
                                "ctrl_FAM.csv",
                                sep = ""
                   )
            )
  }

top_genes <- ctrl.markers %>% group_by(cluster) %>% top_n(20, avg_log2FC)
```

```{r,fig.width=10,fig.height=20}
### Heatmap
str_top_genes <- unique(as.character(top_genes$gene))
DoHeatmap(object = ctrl.object, features = as.character(top_genes$gene),group.by = "RNA_snn_res.1.2", group.bar = T, label = T,size = 5, draw.lines = T, lines.width = 10,group.bar.height = 0.02)
```

# supp_Table 1
```{r,fig.width=10,fig.height=20}
datatable(top_genes, filter = 'top', options = list(pageLength = 20)) %>% formatRound(2:4, 2) %>% formatSignif(c(1,5), digits = 2)
```

# supp_Table 2
![Signatures_proposées](/home/bigott/workspace/Papers/ETV6/99_figures_papier/01_figure_1/supp_table2.png)

# supp_Figure 3 {.tabset}
## Panel 0
```{r,fig.width=10,fig.height=10}
# Plotting pat.object UMAP with "individuals"
DimPlot(object = pat.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "individuals",
        order = T
        )
```

## Panel A
```{r,fig.width=10,fig.height=10}
# Plotting pat.object UMAP with "orig.ident" split by "individuals"
pat.object@meta.data$orig.ident <- factor(pat.object@meta.data$orig.ident,
                                           levels = c("D6", "D11")
                                           )
DimPlot(object = pat.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "orig.ident",
        split.by = "individuals",
        order = T
        )
```

## Panel B
```{r,fig.width=10,fig.height=10}
# Plotting pat.object UMAP with "RNA_snn_res.1.2" and split by "individuals"
DimPlot(object = pat.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "RNA_snn_res.0.8",
        split.by = "individuals",
        order = T,
        label = T,
        label.size = 5
        )
```

# supp_Figure 4
```{r}
# FindAllMarkers
if(file.exists(paste(OUTPUT_PATH, "pat_FAM.csv", sep = ""))){
  pat.markers <- read.csv(file = paste(OUTPUT_PATH, "pat_FAM.csv", sep = ""))
  }else{
  Idents(pat.object) <- "RNA_snn_res.0.8"
  pat.markers <- FindAllMarkers(pat.object,
                                        only.pos = F,
                                        min.pct = 0.1,
                                        logfc.threshold = 0.25,
                                        verbose = T
                                        )
  write.csv(pat.markers,
                   file = paste(OUTPUT_PATH,
                                "pat_FAM.csv",
                                sep = ""
                   )
            )
  }

top_genes <- pat.markers %>% group_by(cluster) %>% top_n(20, avg_log2FC)
```

```{r,fig.width=10,fig.height=20}
### Heatmap
str_top_genes <- unique(as.character(top_genes$gene))
DoHeatmap(object = pat.object, features = as.character(top_genes$gene),group.by = "RNA_snn_res.0.8", group.bar = T, label = T,size = 5, draw.lines = T, lines.width = 10,group.bar.height = 0.02)
```

# supp_Table 3
```{r,fig.width=10,fig.height=20}
datatable(top_genes, filter = 'top', options = list(pageLength = 20)) %>% formatRound(2:4, 2) %>% formatSignif(c(1,5), digits = 2)
```

# supp_Figure 5
```{r,fig.width=10,fig.height=10}
# FeaturePlot on signatures estimated from literature and implemented with genes from top 20 genes of each clusters
# Defining signatures & adding them to the object by incorporating it in the meta.data
ETV6_2020 <- AddModuleScore(ETV6_2020,
                              features = list(c("PROM1","FLT3","CRHBP","HOPX","AVP","IGHM","GLIPR1")),
                              name = "HSPC"
                              )
ETV6_2020 <- AddModuleScore(ETV6_2020,
                              features = list(c("CPA3","PRG2","RHEX","ALOX5AP","MS4A2")),
                              name = "CMP"
                              )
ETV6_2020 <- AddModuleScore(ETV6_2020,
                              features = list(c("MS4A3","RNASE2","EPX","CLC","CSF2RB","CTSG")),
                              name = "non_primed_CMP"
                              )
ETV6_2020 <- AddModuleScore(ETV6_2020,
                              features = list(c("LMNA","CAVIN2","LAT","VWA5A","KIT","HPGDS","KRT1","TPSB2","TPSAB1","TMEM176B","SAMSN1","CD44")),
                              name = "Mk_primed_CMP"
                              )
ETV6_2020 <- AddModuleScore(ETV6_2020,
                              features = list(c("CSTA","MPO","ELANE","PRTN3","AZU1","RNASE3","CFD")),
                              name = "GMP"
                              )
ETV6_2020 <- AddModuleScore(ETV6_2020,
                              features = list(c("CD38","KLF1","DEPTOR","ACSM3","APOC1","TFRC","ANK1","TMSB10","ALDH1A1","MT-ATP8","H2AFY","GYPB")),
                              name = "MEP"
                              )
ETV6_2020 <- AddModuleScore(ETV6_2020,
                              features = list(c("BLVRB","HBB","APOC1","TFR2")),
                              name = "MEP_ERP"
                              )
ETV6_2020 <- AddModuleScore(ETV6_2020,
                              features = list(c("MPIG6B","PF4","GP9","VWF","PPBP","SH3BP5","SELP","LTBP1","TMEM40")),
                              name = "MkP_Mk"
                              )

# FeaturePlots {.tabset}
sig_list <- c("HSPC1","CMP1","non_primed_CMP1","Mk_primed_CMP1","GMP1","MEP1","MEP_ERP1","MkP_Mk1")

for (i in 1:length(sig_list)){
    tryCatch({
      print(sig_list[i])
      print(FeaturePlot(object = ETV6_2020,
                        features = sig_list[i],
                        reduction = "umap",
                        cols = c("grey","lightblue","cyan3","cyan4","dodgerblue3","blue","mediumslateblue","purple","orchid3","red","brown","black"),
                        pt.size = 0.7)+
              NoAxes()+
              NoLegend()
            )
    }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
}
```

# supp_Table 7
![Pathways_dérégulés](/home/bigott/workspace/Papers/ETV6/99_figures_papier/01_figure_1/supp_table7.png)