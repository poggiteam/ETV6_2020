---
title: "Reviewers_responses"
author: "Timothée Bigot"
date: '2023-02-21'
output: html_document
  rmarkdown::html_document:
    code_folding: hide
    theme: cerulean
    toc: true
toc_float:
  toc_collapsed: true
pdf_document:
  toc: true
editor_options: 
  chunk_output_type: console
---

* This script summarize figures present in the "Responses to reviewers" document. 

# Dot Plot of Platelets and RBC markers. 
```{r}
list <- c("GP6","PPBP","ITGA2B","VWF","LTBP1","STXBP5","RAB27B","RGS18","HBB","HBA1","HBA2","FTL","HBG1","BLVRB","GYPA","GYPB")

Idents(ctrl.object) <- "celltypes"
ctrl.object@active.ident <- factor(ctrl.object@active.ident,
                                   levels = c("Plt","MkP_Mk","MEP","CMP_Primed","CMP","GMP","HSPC")
                                   )

dp <- DotPlot(ctrl.object,
              features = list,
              # group.by = "RNA_snn_res.1.2",
              idents = c("Plt","MkP_Mk","MEP")
              ) + 
  geom_point(aes(size=pct.exp),
             shape = 21,
             colour="black",
             stroke=0.5
             ) + 
  scale_colour_gradient2(low = "steelblue",
                         mid = "ivory1",
                         high = "red"
                         ) + 
  guides(size=guide_legend(override.aes=list(shape=21, colour="black", fill="white"))
         ) + 
  RotatedAxis()
dp
```

# Visualize QC metrics as a violin plot
```{r}
VlnPlot(ETV6_2020, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3,pt.size=0, group.by = "HT0_souporcell_classification")
```

# Plot Cell cycle Phases scoring after regression for UMAP on cell cycle phases
```{r}
# Controls
DimPlot(object = ctrl.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "Phase",
        order = F,
        label = F,
        label.size = 6
        )+
  NoAxes()

# Patients
DimPlot(object = pat.object,
        pt.size = 0.7,
        reduction = "umap",
        group.by = "Phase",
        order = F,
        label = F,
        label.size = 6
        )+
  NoAxes()
```

# ETV6 analysis subset on Cluster 9
## Global analysis
```{r}
Idents(ctrl) <- ctrl@meta.data$seurat_clusters
# Samples à garder 
aGarder <- c(9)

liste_a_garder <- rownames(ctrl@meta.data[ctrl@meta.data[["seurat_clusters"]] %in% aGarder,])
length(liste_a_garder)

# Nouvel objet Seurat contenant uniquement les clusters d'intérêts
ctrl_filtered = ctrl[,colnames(ctrl) %in% liste_a_garder]
```

- Some counts after subset
```{r}
ctrl_filtered
table(ctrl_filtered$individuals)
```

- Choose top 1k variable genes
```{r}
ctrl_filtered <- FindVariableFeatures(object=ctrl_filtered, selection.method = "vst", mean.function = ExpMean, dispersion.function = LogVMR, binning.method = "equal_width", num.bin = 20, y.cutoff = 0.5, nfeatures = 1000, verbose=TRUE)

top40 <- head(VariableFeatures(ctrl_filtered), 40)
top100 <- head(VariableFeatures(ctrl_filtered), 100)
```

- Plot variable genes:
```{r}
plot1 <- VariableFeaturePlot(ctrl_filtered)
LabelPoints(plot = plot1, points = top100, repel = TRUE)
```

- Running a PCA on cell cycle genes
```{r}
ctrl_filtered <- RunPCA(ctrl_filtered, features = VariableFeatures(object = ctrl_filtered), npcs=40, pcs.print = 5, seed.use=42, rev.pca = FALSE)
DimPlot(ctrl_filtered,group.by="Phase", reduction = "pca")+ggtitle("PCA - Cell cycle")
DimPlot(ctrl_filtered, group.by = "individuals", reduction = "pca")
```

- JackStraw and ElbowPlot
```{r}
ctrl_filtered <- JackStraw(ctrl_filtered, num.replicate = 100)
ctrl_filtered <- ScoreJackStraw(ctrl_filtered, dims = 1:20)
           
JackStrawPlot(ctrl_filtered, dims = 1:15)
           
ElbowPlot(ctrl_filtered)
```

- Perform clustering 
```{r}
ctrl_filtered <- FindNeighbors(object = ctrl_filtered, k.param = 12, dims = 1:6, compute.SNN = TRUE, prune.SNN = 1/15)

ctrl_filtered <- FindClusters(object= ctrl_filtered, modularity.fxn = 1,
             resolution = 0.3, algorithm = 1, n.start = 10, n.iter = 10,
             random.seed = 42, temp.file.location = NULL, edge.file.name = NULL,
             verbose = TRUE)
clusters_res <- ctrl_filtered[["RNA_snn_res.0.3"]][,1]
names(clusters_res)=colnames(ctrl_filtered)
```

- Look at PCA results again, with clusters
```{r}
DimPlot(ctrl_filtered, dims=c(1, 2), reduction = "pca", pt.size=1)
DimPlot(ctrl_filtered, dims=c(3, 4), reduction = "pca", pt.size=1)
```

- UMAP
```{r}
ctrl_filtered <- RunUMAP(ctrl_filtered, dims = 1:10, umap.method="uwot", seed.use=10, n.components=2, n.neighbors = 10 , spread=1, min.dist=0.1)
DimPlot(ctrl_filtered, reduction = "umap", pt.size=0.7, label = TRUE)

# note that you can set `label = TRUE` or use the LabelClusters function to help label individual clusters
UMAP_coord <- ctrl_filtered@reductions$umap@cell.embeddings
```

- UMAP Cell cycling
```{r}
# A list of cell cycle markers, from Tirosh et al, 2015, is loaded with Seurat.  We can
# segregate this list into markers of G2/M phase and markers of S phase
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes
 
ctrl_filtered <- CellCycleScoring(ctrl_filtered,s.features = s.genes, g2m.features = g2m.genes)
DimPlot(ctrl_filtered,group.by="Phase")+ggtitle("UMAP - Cell cycle")
```

-DotPlot avec signature littérature et gènes d'intérêts sur UMAP subset cluster 9
```{r,fig.width=15,fig.height=5}
signature = list(HSPC = c("PROM1","FLT3","CRHBP","HOPX","AVP","SPINK2","CSF3R","IGHM","GLIPR1"),
                 GMP =  c("MPO","ELANE","PRTN3","AZU1","SERPINB10","CTSG","RNASE3"),
                 CMP = c("CPA3","CLC","PRG2","TPSAB1","RHEX","ALOX5AP","MS4A2","RNASE2","CSF2RB","CTSG","KIT"),
                 MEP = c("CD38","TFRC","DEPTOR","KLF1","TFR2","HBB","APOC1","ANK1","ACSM3","ALDH1A1","BLVRB","GYPB","MYH10","FSCN1"), 
                 MKP_MK = c("VWA5A","LMNA","CAVIN2","LAT","CD9","STOM","PLEK","ITGA2B","GP9","GP6","GP1BA","PF4","RASGRP2","MPIG6B","VWF","PPBP","SELP","LTBP1","SH3BP5","TMEM40","TUBB1","RAB27B","HPSE"))

ctrl_filtered_copy <- ctrl_filtered
# Define an order of cluster identities
my_levels <- c(2,0,1)
Idents(ctrl_filtered_copy) <- factor(Idents(ctrl_filtered_copy), levels= my_levels)

# clean les gènes en soublons par type cellulaires
un <- unlist(signature)
res <- Map(`[`, signature, relist(!duplicated(un), skeleton = signature))

dp <- DotPlot(ctrl_filtered_copy, features = res, dot.scale = 5) + theme(axis.text.x = element_text(size = 11), text = element_text(size = 14),legend.title = element_text(size=14), legend.text = element_text(size=15)) + geom_point(aes(size=pct.exp), shape = 21, colour="black", stroke=0.5) +  scale_colour_gradient2(low = "steelblue", mid = "ivory1", high = "red") + guides(size=guide_legend(override.aes=list(shape=21, colour="black", fill="white"))) + RotatedAxis() 
dp
```

- DotPlot TOP 20 genes sur UMAP subset cluster 9
```{r dotplot_pat, echo=FALSE, fig.width=18,fig.height=5}

ctrl_filtered_copy <- ctrl_filtered
# Define an order of cluster identities
my_levels <- c(2,0,1)
Idents(ctrl_filtered) <- factor(Idents(ctrl_filtered), levels= my_levels)

dp <- DotPlot(ctrl_filtered, features = unique(top5_genes$gene), dot.scale = 4) + theme(axis.text.x = element_text(size = 10)) + geom_point(aes(size=pct.exp), shape = 21, colour="black", stroke=0.5) +  scale_colour_gradient2(low = "steelblue", mid = "ivory1", high = "red") + guides(size=guide_legend(override.aes=list(shape=21, colour="black", fill="white"))) + RotatedAxis() 
dp
```

```{r}
ctrl@meta.data <- ctrl@meta.data[,-c(47,48)]

ctrl <- AddModuleScore(ctrl,

                              features = list(c("BLVRB","HBB","APOC1","TFR2")),

                              name = "MEP_ERP"

                              )

ctrl <- AddModuleScore(ctrl,

                              features = list(c("MPIG6B","PF4","GP9","VWF","PPBP","SH3BP5","SELP","LTBP1","TMEM40")),

                              name = "MkP_Mk"

                              )

```

- Subset on MEP clusters: 0,2,4,5,9 
```{r}
Idents(ctrl) <- ctrl@meta.data$seurat_clusters
# Samples à garder 
aGarder <- c(9,5,4,0,2)

liste_a_garder <- rownames(ctrl@meta.data[ctrl@meta.data[["seurat_clusters"]] %in% aGarder,])
length(liste_a_garder)

# Nouvel objet Seurat contenant uniquement les clusters d'intérêts
ctrl_filtered = ctrl[,colnames(ctrl) %in% liste_a_garder]
```

- ViolinPlot for global relative score (MEP and MkP_Mk) on MEP clusters
```{r}
myColors <- c("#53B400","#F8766D","#C49A00","#00C094","#00B6EB","#00B6EB","#00B6EB","#00B6EB","#00B6EB","#A58AFF","#A58AFF","#A58AFF","#A58AFF","#A58AFF","#FB61D7")

  Idents(ctrl_filtered) <- "seurat_clusters"
  ctrl_filtered@meta.data$seurat_clusters <- factor(ctrl_filtered@meta.data$seurat_clusters,
                                                  levels = c(9,5,4,0,2))
  
  p1 <- VlnPlot(ctrl_filtered,
                features = "MEP_ERP1",
                pt.size = 0,
                group.by = "seurat_clusters",
                log = F,
                cols = myColors,
                assay = "RNA"
                ) + NoLegend() + geom_boxplot()
  
  p2 <- VlnPlot(ctrl_filtered,
                features = "MkP_Mk1",
                pt.size = 0,
                group.by = "seurat_clusters",
                log = T,
                cols = myColors,
                assay = "RNA"
                ) + NoLegend() + geom_boxplot()

  plot(p1)
  plot(p2)
```
