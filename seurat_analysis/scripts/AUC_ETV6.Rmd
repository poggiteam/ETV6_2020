---
title: "AUC_ETV6"
author: "Timothée Bigot"
date: '2022-07-12'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
library(Seurat)
library(ggplot2)
library(dplyr)
library(ggrepel)
library(plotly)
library(DT)
library(SeuratObject)
library(Rtsne)
library(umap)
library(uwot)

#Load SCENIC output to add to the Seurat object
# If you ran yourself the SCENIC analysis, you produced your own file so you can change the data folder to :
#DATA_FOLDER="<WORKING_DIR>/scenic_analysis/outputs/"

aucmtx = t(read.table(file = paste0(DATA_FOLDER, "auc_mtx.csv"), sep = ',', header = F, row.names = 1))
rownames(aucmtx) <- aucmtx[,1]

ETV6_2020 <- readRDS(file = "<WORKING_DIR>/ETV6_2020_regressed_final.rds")
```


```{r add_auc, include=FALSE}
### Adding AUC
########################################
# Add AUC data as a new assay independent from RNA
ETV6_2020[["AUC"]] <- CreateAssayObject(counts = aucmtx[,colnames(ETV6_2020)])

# Check regulons
rownames(ETV6_2020@assays$AUC)

saveRDS(ETV6_2020, file = "/home/bigott/workspace/hdd/01_etv6/05_Outputs/06_Février_2022/03_2020-42-set1et2/combined/ETV6_2020_regressed_final.rds")
```

# Duplicate object
```{r}
auc_ETV6_2020 <- ETV6_2020

cat(names(ETV6_2020), sep="\n")

cat(names(auc_ETV6_2020), sep="\n")

auc_ETV6_2020@meta.data$celltypes <- factor(auc_ETV6_2020@meta.data$celltypes, levels = c("HSPC","CMP","CMP_Primed","GMP","MEP","MkP_Mk","Plt"))
```
# UMAP plotting
```{r}
coordinates <- uwot::umap(X = t(as.matrix(auc_ETV6_2020@assays$AUC@counts)), n_neighbors = 20, n_components = 2, metric = "cosine", scale = NULL, min_dist = 0.1)
# coordinates <- uwot::umap(X = t(as.matrix(auc_ETV6_2020@assays$AUC@counts)), n_neighbors = 20, n_components = 3, metric = "cosine", scale = NULL, min_dist = 0.1)
```
# Visualization ggplot
```{r}
df <- data.frame(cells = rownames(auc_ETV6_2020@meta.data),
                 UMAP_1 = coordinates[,1],
                 UMAP_2 = coordinates[,2],
                 # UMAP_3 = coordinates[,3],
                 ETV6status = auc_ETV6_2020@meta.data$ETV6status,
                 celltypes = auc_ETV6_2020@meta.data$celltypes
                 )

myColors <- c("#04BF68","#F26D6D","#CD9600","#7CAE00","#05AFF2","#CC88FF","#F25ECB")

ggplot(df, aes(x = UMAP_1, y = UMAP_2, col = celltypes)) +
  geom_point(size = .7, alpha = 1) +
  scale_color_manual(values = myColors) + 
  theme_classic()

# p1 <- plot_ly(x=df$UMAP_1, y=df$UMAP_2, z=df$UMAP_3, type="scatter3d", mode="markers", color=df$celltypes, size = 0.2)
# p1
```

# Split object 
```{r}
df_ctrl <- df[df$ETV6status == "Controls",]

ggplot(df_ctrl, aes(x = UMAP_1, y = UMAP_2, col = celltypes)) +
  geom_point(size = .7, alpha = 1) +
  scale_color_manual(values = myColors) +
  theme_classic()
```
# split object
```{r}
df_pat <- df[df$ETV6status == "Patients",]

ggplot(df_pat, aes(x = UMAP_1, y = UMAP_2, col = celltypes)) +
  geom_point(size = .7, alpha = 1) +
  scale_color_manual(values = myColors) +
  theme_classic()
```

# auc_ETV6_2020 Find all markers in AUC assay

```{r}
OUTPUT_PATH <- "<WORKING_DIR>/FAM/"

auc_ETV6_2020@meta.data$celltypes <- factor(auc_ETV6_2020@meta.data$celltypes, levels = c("HSPC","GMP","CMP","CMP_Primed","MEP","MkP_Mk","Plt"))

# FindAllMarkers
if(file.exists(paste0(OUTPUT_PATH, "auc_ETV6_2020_FAM_regulons.csv"))){
  regulons <- read.csv(file = paste0(OUTPUT_PATH, "auc_ETV6_2020_FAM_regulons.csv"))
  }else{
  Idents(auc_ETV6_2020) <- "celltypes"
  regulons <- FindAllMarkers(auc_ETV6_2020,
                                  only.pos = F,
                                  min.pct = 0.1,
                                  logfc.threshold = 0,
                                  verbose = T,
                                  assay = "AUC"
                                  )
  write.csv(regulons,
                   file = paste0(OUTPUT_PATH,
                                "auc_ETV6_2020_FAM_regulons.csv"
                                )
            )
  }


## Heatmap all regulons in every cells

all.regulons <- rownames(auc_ETV6_2020@assays$AUC)

auc_ETV6_2020@meta.data$celltypes_ETV6status <- factor(auc_ETV6_2020@meta.data$celltypes_ETV6status, levels = c("Controls_HSPC","Patients_HSPC","Controls_GMP","Patients_GMP","Controls_CMP_Primed","Patients_CMP_Primed","Controls_CMP","Patients_CMP","Controls_MEP","Patients_MEP","Controls_MkP_Mk","Patients_MkP_Mk","Controls_Plt","Patients_Plt"))

auc_ETV6_2020 <- ScaleData(auc_ETV6_2020,
                           assay = "AUC",
                           features = all.regulons,
                           do.scale = T,
                           do.center = T,
                           model.use = "linear",
                           verbose = T
                           )

DoHeatmap(auc_ETV6_2020, features = all.regulons, group.by = "celltypes_ETV6status", assay = "AUC", slot = "scale.data", label = T) + scale_fill_gradientn(colors = c("blue","white","red"))
```

# ETV6_2020_ctrl

```{r}
ctrl.object <- readRDS(file = "/home/bigott/workspace/hdd/01_etv6/05_Outputs/06_Février_2022/03_2020-42-set1et2/ctrl/ctrl_object.rds")

OUTPUT_PATH <- "/home/bigott/workspace/Papers/ETV6/99_figures_papier/SCENIC_06_20222/FAM/"

ctrl.object@meta.data$celltypes <- factor(ctrl.object@meta.data$celltypes, levels = c("HSPC","GMP","CMP","CMP_Primed","MEP","MkP_Mk","Plt"))

# FindAllMarkers
if(file.exists(paste0(OUTPUT_PATH, "ctrl.object_FAM_regulons.csv"))){
  ctrl.regulons <- read.csv(file = paste0(OUTPUT_PATH, "ctrl.object_FAM_regulons.csv"))
  }else{
  Idents(ctrl.object) <- "celltypes"
  ctrl.regulons <- FindAllMarkers(ctrl.object,
                                  only.pos = F,
                                  min.pct = 0.1,
                                  logfc.threshold = 0,
                                  verbose = T,
                                  assay = "AUC",
                                  test.use = "wilcox"
                                  )
  write.csv(ctrl.regulons,
                   file = paste0(OUTPUT_PATH,
                                "ctrl.object_FAM_regulons.csv"
                                )
            )
  }

all.regulons <- rownames(ctrl.object@assays$AUC)

ctrl.object <- ScaleData(ctrl.object, assay = "AUC", features = all.regulons, do.scale = T, do.center = T)

ctrl.top20 <- ctrl.regulons %>% group_by(cluster) %>% top_n(20, avg_log2FC)

datatable(ctrl.regulons, filter = 'top', options = list(pageLength = 20)) %>% formatRound(2:4, 2) %>% formatSignif(c(1,5), digits = 2)

## Heatmap top 20 regulons FAM in controls 

DoHeatmap(ctrl.object, features = ctrl.top20$gene, group.by = "celltypes", assay = "AUC", slot = "scale.data", label = T, raster = T) + scale_fill_gradientn(colors = c("blue","white","red"))
```

#COMPARISON

# creating metadata "celltypes_ETV6status"

```{r}
auc_ETV6_2020@meta.data$celltypes_ETV6status <- paste(auc_ETV6_2020@meta.data$ETV6status,
                                                  auc_ETV6_2020@meta.data$celltypes,
                                                  sep = "_"
                                                  )
```
# Comparing AUC activities for patients versus controls in every celltypes 
```{r}
Idents(auc_ETV6_2020) <- "celltypes_ETV6status"

list_tmp <- c(unique(auc_ETV6_2020@meta.data$celltypes))

OUTPUT_PATH <- "/home/bigott/workspace/Papers/ETV6/99_figures_papier/SCENIC_06_20222/FM/"

for (i in list_tmp[1:length(list_tmp)]){
  if(i != "Plt"){
    if(file.exists(paste0(OUTPUT_PATH,paste0("celltype_", i,".reg_ETV6_2020_full.csv")))){
       assign(paste0("celltype_", i,".reg"),read.csv(paste0(OUTPUT_PATH,paste0("celltype_", i,".reg_ETV6_2020_full.csv"))))}
    else{
      assign(paste0("celltype_", i,".reg"), FindMarkers(auc_ETV6_2020,assay = "AUC", ident.1 = paste("Patients", i, sep = "_"), ident.2 = paste("Controls", i, sep = "_"), only.pos = F, test.use = "wilcox", logfc.threshold = 0, min.pct = 0))
      print(paste0("celltype_", i,".reg"))
      print(head(get(paste0("celltype_", i,".reg")),n=50))
      write.table(get(paste0("celltype_", i,".reg")),
                  paste0(OUTPUT_PATH, "celltype_", i,".reg_ETV6_2020_full.csv"), sep = ",", quote = F)}
  }
}
```

# Heatmaps auc_ETV6_2020 analysis

```{r}
OUTPUT_PATH <- "/home/bigott/workspace/Papers/ETV6/99_figures_papier/SCENIC_06_20222/FM/"

# Selecting Top 20 genes per cluster and making a list of it
for (i in list_tmp[1:length(list_tmp)]) {
   if(i != "Plt"){
     assign(paste0("celltype_", i,".top20"),rownames(get(paste0("celltype_", i,".reg")) %>% top_n(20, avg_log2FC)))
     write.table(get(paste0("celltype_", i,".reg")),
                  paste0(OUTPUT_PATH, "celltype_", i,".reg_ETV6_2020_top20.csv"), sep = ",", quote = F)
     }
}


## Heatmaps
DoHeatmap(auc_ETV6_2020, features = celltype_MkP_Mk.top20, group.by = "celltypes_ETV6status", assay = "AUC", slot = "scale.data", cells = rownames(auc_ETV6_2020@meta.data[auc_ETV6_2020@meta.data$celltypes == "MkP_Mk",])) + scale_fill_gradientn(colors = c("blue","white","red"))

DoHeatmap(auc_ETV6_2020, features = celltype_CMP.top20, group.by = "celltypes_ETV6status", assay = "AUC", slot = "scale.data", cells = rownames(auc_ETV6_2020@meta.data[auc_ETV6_2020@meta.data$celltypes == "CMP",])) + scale_fill_gradientn(colors = c("blue","white","red"))

DoHeatmap(auc_ETV6_2020, features = celltype_MEP.top20, group.by = "celltypes_ETV6status", assay = "AUC", slot = "scale.data", cells = rownames(auc_ETV6_2020@meta.data[auc_ETV6_2020@meta.data$celltypes == "MEP",])) + scale_fill_gradientn(colors = c("blue","white","red"))

# DoHeatmap(auc_ETV6_2020, features = "ETV6(+)", group.by = "celltypes_ETV6status", assay = "AUC", slot = "scale.data") + scale_fill_gradientn(colors = c("blue","white","red"))
```

## Vln from comparison heatmaps with top 20 genes FM

``` {r loadSCENICoutput}
TFregulon = "auc_JUNB(+)"
```

ETV6 regulon activity (calculated by SCENIC)
* data not scaled ! quantitative compared to heatmaps (qualitative)

``` {r KLF6regulonplot, fig.width = 5, fig.height = 7}
VlnPlot(auc_ETV6_2020,group.by = "celltypes", features =  TFregulon, pt.size = 0, split.by = "ETV6status", assay = "AUC", slot = "data")+
       geom_boxplot(colour = "black", width=0.2, outlier.alpha = 0, position = position_dodge(0.9))
```
